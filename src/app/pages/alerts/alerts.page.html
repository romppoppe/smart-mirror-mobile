<ion-content [fullscreen]="true" class="bg-hud">
  
  <div class="hud-scanlines"></div>
  <div class="hud-glow"></div>

  <div class="main-container ion-padding-bottom">

    <header class="hud-header">
      <div class="header-top">
        <div class="brand-group">

          <!-- ✅ FIX: usar button + el transform en el SVG (no en <use>) -->
          <button class="logo-box" type="button" (click)="goBack()" aria-label="Volver">
            <svg class="lucide-icon" style="width: 22px; height: 22px; transform: rotate(180deg);">
              <use href="#lucide-chevron-right"></use>
            </svg>
          </button>

          <div class="titles">
            <h1>Alertas</h1>
            <span class="device-badge">Historial de salud</span>
          </div>
        </div>
      </div>
    </header>

    <div class="content-stack">

      <div class="filter-container">
        <div class="custom-segment">
          <button 
            [class.active]="filter === 'pending'" 
            (click)="filter = 'pending'"
            class="segment-btn">
            Pendientes
          </button>
          <button 
            [class.active]="filter === 'all'" 
            (click)="filter = 'all'"
            class="segment-btn">
            Historial Completo
          </button>
        </div>
      </div>

      <div *ngIf="loading" class="loading-state">
        <ion-spinner name="crescent" style="color: var(--ion-color-primary);"></ion-spinner>
        <p>Recuperando datos...</p>
      </div>

      <div *ngIf="!loading && shownAlerts.length === 0" class="empty-state">
        <div class="icon-circle">
          <svg class="lucide-icon"><use href="#lucide-check-circle2"></use></svg>
        </div>
        <h3>Todo despejado</h3>
        <p>No hay alertas {{ filter === 'pending' ? 'pendientes' : 'registradas' }} por ahora.</p>
      </div>

      <div class="alerts-list">
        <div 
          class="hud-card alert-item" 
          *ngFor="let a of shownAlerts"
          [class.handled-item]="a.handled"
          [class.risk]="getStatus(a) === 'risk'" 
          [class.warning]="getStatus(a) === 'warning'">
          
          <div class="hud-brackets"></div>

          <div class="alert-content">
            <div class="alert-header">
              <div class="meta-left">
                <span class="status-badge">
                  {{ statusLabel(getStatus(a)) }}
                </span>
                <span class="timestamp">
                  {{ formatTs(a.createdAt) }}
                </span>
              </div>
              <div class="icon-indicator">
                <svg *ngIf="a.handled" class="lucide-icon"><use href="#lucide-check-circle2"></use></svg>
                <svg *ngIf="!a.handled" class="lucide-icon"><use href="#lucide-bell"></use></svg>
              </div>
            </div>

            <div class="reasons-list" *ngIf="a.reasons?.length">
              <p *ngFor="let r of a.reasons">
                <svg class="lucide-icon bullet"><use href="#lucide-alert-circle"></use></svg>
                {{ r }}
              </p>
            </div>

            <div class="vitals-row">
              <div class="vital-pill" *ngIf="a.vitals?.hr != null">
                <svg class="lucide-icon"><use href="#lucide-heart"></use></svg>
                <span>{{ a.vitals?.hr }} bpm</span>
              </div>
              <div class="vital-pill" *ngIf="a.vitals?.spo2 != null">
                <svg class="lucide-icon"><use href="#lucide-droplets"></use></svg>
                <span>{{ a.vitals?.spo2 }}%</span>
              </div>
              <div class="vital-pill" *ngIf="a.vitals?.temp != null">
                <svg class="lucide-icon"><use href="#lucide-activity"></use></svg>
                <span>{{ a.vitals?.temp }}°C</span>
              </div>
            </div>

            <button 
              *ngIf="a.handled !== true" 
              class="action-btn" 
              (click)="markAsHandled(a)">
              Marcar como atendida
            </button>

            <div *ngIf="a.handled === true" class="handled-note">
              Atendida el {{ formatTs(a.handledAt || a.createdAt) }}
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</ion-content>
